---
- hosts: local
  vars_files:
    - "../group_vars/all.yml"

  tasks:
    - name: Add helm repo ingress-nginx
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx

    - name: Create namespace ingress
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespaces.ingress }}"

    # --------- Aqui simplificamos os cÃ¡lculos sem Jinja no mapa ---------
    - name: Defaults para annotations e LB IP
      set_fact:
        ingress_annotations: {}
        ingress_lb_ip: "{{ omit }}"

    - name: Define annotations e LB IP se ingress_ip foi informado
      set_fact:
        ingress_annotations:
          service.beta.kubernetes.io/azure-load-balancer-resource-group: "{{ rg_name }}"
        ingress_lb_ip: "{{ ingress_ip }}"
      when: (ingress_ip | default('') | length) > 0
    # --------------------------------------------------------------------

    - name: Install ingress-nginx
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig }}"
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: "{{ namespaces.ingress }}"
        create_namespace: false
        values:
          controller:
            service:
              annotations: "{{ ingress_annotations }}"
              loadBalancerIP: "{{ ingress_lb_ip }}"

    - name: Add helm repo jetstack
      kubernetes.core.helm_repository:
        name: jetstack
        repo_url: https://charts.jetstack.io

    - name: Create namespace cert-manager
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespaces.certmgr }}"

    - name: Install cert-manager (com CRDs)
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig }}"
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: "{{ namespaces.certmgr }}"
        create_namespace: false
      values:
        installCRDs: true

