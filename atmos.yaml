# yaml-language-server: $schema=https://atmos.tools/schemas/atmos-manifest/1.0/atmos-manifest.json
components:
  terraform:
    base_path: "components/terraform"
  helmfile:
    base_path: "components/helmfile"

stacks:
  base_path: "stacks"
  included_paths:
    - "stacks/**/*.yaml"       # somente YAML dentro de stacks/
  excluded_paths:
    - "**/_defaults/**/*"
    - "components/**"          # ignora helm charts e terraform modules
  name_pattern: "{region}/{stage}"

cli:
  log:
    level: info
  terraform:
    apply_auto_approve: true
    plan: true

workflows:
  up-dev:
    description: "Provisiona DEV (RG, VNet, AKS) e instala addons + Kafka"
    steps:
      - atmos terraform apply azure/resource-group -s ue2/dev
      - atmos terraform apply azure/network -s ue2/dev
      - atmos terraform apply azure/aks -s ue2/dev
      - atmos helmfile apply base -s ue2/dev
      - atmos helmfile apply dev -s ue2/dev
      - atmos helmfile apply gitops -s ue2/dev   # <--- NOVO

  up-hml:
    steps:
      - atmos terraform apply azure/resource-group -s ue2/hml
      - atmos terraform apply azure/network -s ue2/hml
      - atmos terraform apply azure/aks -s ue2/hml
      - atmos helmfile apply base -s ue2/hml

  up-prod:
    steps:
      - atmos terraform apply azure/resource-group -s ue2/prod
      - atmos terraform apply azure/network -s ue2/prod
      - atmos terraform apply azure/aks -s ue2/prod
      - atmos helmfile apply base -s ue2/prod
